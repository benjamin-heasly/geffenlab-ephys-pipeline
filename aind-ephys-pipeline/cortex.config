params {
    // These four "coordinates" locate the data and results for one session.
    data_root = System.getenv('DATA_ROOT') ?: '/vol/cortex/cd4/geffenlab/data'
    analysis_root = System.getenv('ANALYSIS_ROOT') ?: '/vol/cortex/cd4/geffenlab/analysis'
    subject = System.getenv('SUBJECT_ID') ?: 'AS20-minimal2'
    date = System.getenv('DATE') ?: '03112025'

    // Organize data in and analysis out by subject and date.
    data_path = "${params.data_root}/${params.subject}/${params.date}"
    analysis_path = "${params.analysis_root}/${params.subject}/${params.date}"

    ecephys_path = "${params.data_path}/ecephys/"
    results_path = "${params.analysis_path}/sorted/"

    // Use 10 CPU cores at a time -- not all of them!
    n_jobs = 10

    // Choose default parameters for several pipeline steps.
    sorter = 'kilosort4'
    job_dispatch_args = '--input spikeglx'
    preprocessing_args = '--motion compute --min-duration-for-preprocessing 10'
    nwb_ecephys_args = '--skip-lfp'
}

env {
    // Some pipeline code uses these environment variables explicitly (as opposed to using params).
    DATA_PATH=params.ecephys_path
    RESULTS_PATH=params.results_path
}

process {
    debug = true
    executor = 'local'
    cpus = 10
    memory = '64 GB'
    containerOptions = "--env CO_CPUS=${params.n_jobs} --shm-size=4g"

    // change max forks for specific processes to allow multiple forks
    withName: preprocessing {
        maxForks = 1
    }
    withName: spikesort_kilosort4 {
        maxForks = 1
        containerOptions = '--gpus "device=3"'
    }
    withName: spikesort_kilosort25 {
        maxForks = 1
        containerOptions = '--gpus all'
    }
    withName: spikesort_spykingcircus2 {
        maxForks = 1
    }
    withName: postprocessing {
        maxForks = 1
    }
    withName: quality_control {
        maxForks = 1
    }
}

docker {
    enabled = true
    platform = 'linux/amd64'
    runOptions = "--volume ${params.ecephys_path}:/tmp/data"
    envWhitelist = ['KACHERY_ZONE', 'KACHERY_API_KEY']
}

dag {
    enabled = true
    file = "${params.analysis_path}/sorted/nextflow/dag.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.analysis_path}/sorted/nextflow/report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.analysis_path}/sorted/nextflow/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.analysis_path}/sorted/nextflow/trace.txt"
    overwrite = true
}
